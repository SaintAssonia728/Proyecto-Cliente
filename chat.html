<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat en Vivo - Supabase</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.5.0/dist/umd/supabase.min.js"></script>
</head>
<body>
    <div class="container py-4">
        <h1 class="h4 mb-3">Chat en Vivo</h1>
        <div id="chatMessages" class="mb-3" style="height: 300px; overflow-y: scroll; border: 1px solid #ddd; padding: 10px;">
            </div>
        <div class="input-group">
            <input type="text" id="messageInput" class="form-control" placeholder="Escribe un mensaje..." />
            <button class="btn btn-primary" id="sendMessageBtn">Enviar</button>
        </div>
        <div id="errorDisplay" style="color: red; margin-top: 20px; display: none;">
            <strong>Error:</strong> <span id="errorMessage"></span>
        </div>
    </div>

    <script>
        // Declaración del cliente de Supabase usando 'var' (ámbito más seguro)
        var supabaseClient;

        // Configuración de Supabase
        const supabaseUrl = 'https://pfxomdslkkmkjmppoyay.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmeG9tZHNsa2tta2ptcHBveWF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MDYyNzIsImV4cCI6MjA3NjE4MjI3Mn0.NnjJW91J_4WMG6_qV1V4kh3l9Hep2MIUNIoDLQRYAxM';
        
        // ✨ Obtener el nombre de usuario desde localStorage
        const CURRENT_USERNAME = localStorage.getItem('current_user_name') || 'Usuario Desconocido';
        
        // Función para mostrar mensajes en el área de chat
        function renderMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('mb-2');
            // ✨ Mostrar el nombre de usuario guardado en la columna 'username'
            messageElement.innerHTML = `<strong>${message.username || 'Anónimo'}</strong>: ${message.text}`;
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Función para cargar mensajes existentes desde Supabase (Consulta REST)
        async function loadMessages() {
            try {
                const { data, error } = await supabaseClient
                    .from('messages')
                    .select('username, text') // Seleccionamos las columnas relevantes
                    .order('created_at', { ascending: true });

                if (error) {
                    document.getElementById('errorDisplay').style.display = 'block';
                    document.getElementById('errorMessage').textContent = `Error al cargar mensajes: ${error.message}`;
                } else {
                    data.forEach(message => renderMessage(message));
                }
            } catch (err) {
                console.error('Error inesperado al cargar mensajes:', err);
            }
        }

        // Función para enviar mensajes (Mutación REST)
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();

            if (messageText) {
                try {
                    // USANDO: supabaseClient
                    const { error } = await supabaseClient
                        .from('messages')
                        .insert([
                            { 
                                // ✨ ENVIAR EL NOMBRE DE USUARIO ACTUAL
                                username: CURRENT_USERNAME, 
                                user_id: 'anon', // Mantenemos este por compatibilidad
                                type: 'message',
                                text: messageText
                            }
                        ]);

                    if (error) {
                        document.getElementById('errorDisplay').style.display = 'block';
                        document.getElementById('errorMessage').textContent = `Error al enviar mensaje: ${error.message}`;
                    } else {
                        messageInput.value = '';
                    }
                } catch (err) {
                    console.error('Error inesperado al enviar mensaje:', err);
                }
            }
        }
        
        // Función principal para inicializar la aplicación y el cliente
        function initApp() {
            // 1. Inicialización de Supabase
            supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

            // 2. Suscripción a Realtime
            try {
                const chatChannel = supabaseClient.channel('public:messages'); 

                chatChannel
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                        renderMessage(payload.new);
                    })
                    .subscribe(); 

            } catch (e) {
                console.error('Error al iniciar la suscripción en tiempo real:', e);
                 document.getElementById('errorDisplay').style.display = 'block';
                 document.getElementById('errorMessage').textContent = 'Error al iniciar el chat en tiempo real. Revisa la configuración de Realtime en Supabase.';
            }


            // 3. Event listeners
            document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // 4. Cargar mensajes iniciales
            loadMessages();
        }

        // Ejecutar la función de inicialización al cargar el script
        initApp();
    </script>
</body>
</html>