<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Contactos</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 2rem; background-color: #f8f9fa; }
        .container { max-width: 900px; }
        .card-contact { margin-bottom: 1rem; }
        .modal .invalid-feedback { display:block; }
        #errorMessage { margin-top: 1rem; }
    </style>
</head>
<body>

    <div class="container">
        <div class="d-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0">Lista de Contactos</h1>
            <div>
                <button id="btnCrear" class="btn btn-primary">Crear Contacto</button>
                <button id="btnLogout" class="btn btn-outline-secondary ms-2">Cerrar sesión</button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div id="contactosList" class="row">
            <!-- Cards se inyectarán aquí -->
        </div>

        <div id="loading" class="text-center my-4" style="display:none;">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>
        </div>
    </div>

    <!-- MODAL CREAR -->
    <div class="modal fade" id="modalCrear" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="formCrear">
            <div class="modal-header">
              <h5 class="modal-title">Crear Contacto</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div id="crear_alert" ></div>

                <div class="mb-3">
                    <label for="crear_nombre" class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="crear_nombre" required>
                    <div class="invalid-feedback" data-field="nombre"></div>
                </div>
                <div class="mb-3">
                    <label for="crear_correo" class="form-label">Correo</label>
                    <input type="email" class="form-control" id="crear_correo" required>
                    <div class="invalid-feedback" data-field="correo"></div>
                </div>
                <div class="mb-3">
                    <label for="crear_telefono" class="form-label">Teléfono</label>
                    <input type="text" class="form-control" id="crear_telefono" required placeholder="+56912345678">
                    <div class="invalid-feedback" data-field="telefono"></div>
                </div>
                <div class="mb-3">
                    <label for="crear_direccion" class="form-label">Dirección</label>
                    <input type="text" class="form-control" id="crear_direccion" required>
                    <div class="invalid-feedback" data-field="direccion"></div>
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- MODAL EDITAR -->
    <div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="formEditar">
            <div class="modal-header">
              <h5 class="modal-title">Editar Contacto</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div id="editar_alert" ></div>

                <input type="hidden" id="editar_id">
                <div class="mb-3">
                    <label for="editar_nombre" class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="editar_nombre" required>
                    <div class="invalid-feedback" data-field="nombre"></div>
                </div>
                <div class="mb-3">
                    <label for="editar_correo" class="form-label">Correo</label>
                    <input type="email" class="form-control" id="editar_correo" required>
                    <div class="invalid-feedback" data-field="correo"></div>
                </div>
                <div class="mb-3">
                    <label for="editar_telefono" class="form-label">Teléfono</label>
                    <input type="text" class="form-control" id="editar_telefono" required placeholder="+56912345678">
                    <div class="invalid-feedback" data-field="telefono"></div>
                </div>
                <div class="mb-3">
                    <label for="editar_direccion" class="form-label">Dirección</label>
                    <input type="text" class="form-control" id="editar_direccion" required>
                    <div class="invalid-feedback" data-field="direccion"></div>
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-success">Actualizar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const apiUrl = 'http://localhost:8000/api/contactos/';
        const token = localStorage.getItem('access_token');

        // Si no hay token, redirigir al login
        if (!token) {
            window.location.href = 'index.html';
        }

        // Helpers UI
        const alertContainer = document.getElementById('alertContainer');
        function showAlert(message, type = 'danger', timeout = 6000) {
            alertContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                  ${escapeHtml(message)}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                </div>
            `;
            if (timeout) setTimeout(() => {
                const alert = alertContainer.querySelector('.alert');
                if (alert) bootstrap.Alert.getOrCreateInstance(alert).close();
            }, timeout);
        }

        function clearFormErrors(formElement) {
            formElement.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            formElement.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
            const localAlert = formElement.querySelector('[id$="_alert"]');
            if (localAlert) localAlert.innerHTML = '';
        }

        function displayFormErrors(formElement, errors) {
            // errors: objeto devuelto por la API, p.ej { correo: ["..."], non_field_errors: ["..."] }
            clearFormErrors(formElement);
            for (const [key, value] of Object.entries(errors)) {
                const msg = Array.isArray(value) ? value.join(' ') : String(value);
                if (key === 'non_field_errors' || key === 'detail' || key === 'error') {
                    const container = formElement.querySelector(`[id$="_alert"]`);
                    if (container) {
                        container.innerHTML = `<div class="alert alert-danger">${escapeHtml(msg)}</div>`;
                    } else {
                        showAlert(msg, 'danger');
                    }
                } else {
                    const field = formElement.querySelector(`[id$="_${key}"]`) || formElement.querySelector(`#${key}`);
                    if (field) {
                        field.classList.add('is-invalid');
                        // find corresponding invalid-feedback with data-field or general invalid-feedback under field
                        let fb = formElement.querySelector(`.invalid-feedback[data-field="${key}"]`);
                        if (!fb) {
                            fb = field.nextElementSibling;
                        }
                        if (fb) fb.textContent = msg;
                    } else {
                        // si no lo podemos mapear, mostrar en alert general
                        showAlert(`${key}: ${msg}`, 'danger');
                    }
                }
            }
        }

        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        // Modales Bootstrap
        const modalCrearEl = document.getElementById('modalCrear');
        const modalCrear = new bootstrap.Modal(modalCrearEl);
        const formCrear = document.getElementById('formCrear');

        const modalEditarEl = document.getElementById('modalEditar');
        const modalEditar = new bootstrap.Modal(modalEditarEl);
        const formEditar = document.getElementById('formEditar');

        document.getElementById("btnCrear").addEventListener("click", () => {
            formCrear.reset();
            clearFormErrors(formCrear);
            modalCrear.show();
        });

        document.getElementById("btnLogout").addEventListener("click", () => {
            localStorage.removeItem('access_token');
            window.location.href = 'index.html';
        });

        // ---- LISTAR CONTACTOS ----
        const contactosList = document.getElementById("contactosList");
        const loadingEl = document.getElementById('loading');

        async function fetchContactos() {
            try {
                loadingEl.style.display = 'block';
                const response = await fetch(apiUrl, {
                    method: "GET",
                    headers: { "Authorization": "Bearer " + token }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        showAlert('Sesión expirada. Por favor inicia sesión de nuevo.', 'warning', 8000);
                        localStorage.removeItem('access_token');
                        setTimeout(() => window.location.href = 'index.html', 1500);
                    } else {
                        throw new Error("Error al obtener contactos");
                    }
                    return;
                }

                const data = await response.json();
                contactosList.innerHTML = "";

                const results = Array.isArray(data.results) ? data.results : (Array.isArray(data) ? data : []);
                if (results.length === 0) {
                    contactosList.innerHTML = '<div class="col-12"><div class="alert alert-info">No hay contactos.</div></div>';
                }

                results.forEach(contacto => {
                    const col = document.createElement('div');
                    col.className = 'col-12';

                    const card = document.createElement('div');
                    card.className = 'card card-contact shadow-sm';

                    const cardBody = document.createElement('div');
                    cardBody.className = 'card-body d-flex justify-content-between align-items-start';

                    const info = document.createElement('div');
                    info.innerHTML = `
                        <h5 class="card-title mb-1">${escapeHtml(contacto.nombre)}</h5>
                        <p class="card-text mb-0"><strong>Correo:</strong> ${escapeHtml(contacto.correo)}</p>
                        <p class="card-text mb-0"><strong>Teléfono:</strong> ${escapeHtml(contacto.telefono)}</p>
                        <p class="card-text mb-0"><strong>Dirección:</strong> ${escapeHtml(contacto.direccion)}</p>
                    `;

                    const actions = document.createElement('div');
                    actions.className = 'd-flex flex-column align-items-end gap-2';

                    const btnEdit = document.createElement('button');
                    btnEdit.className = 'btn btn-sm btn-outline-primary';
                    btnEdit.textContent = 'Editar';
                    btnEdit.addEventListener('click', () => mostrarEditar(contacto));

                    const btnDelete = document.createElement('button');
                    btnDelete.className = 'btn btn-sm btn-outline-danger';
                    btnDelete.textContent = 'Eliminar';
                    btnDelete.addEventListener('click', () => eliminarContacto(contacto.id));

                    actions.appendChild(btnEdit);
                    actions.appendChild(btnDelete);

                    cardBody.appendChild(info);
                    cardBody.appendChild(actions);
                    card.appendChild(cardBody);
                    col.appendChild(card);
                    contactosList.appendChild(col);
                });

            } catch (error) {
                showAlert(error.message || 'Error desconocido al cargar contactos.');
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        fetchContactos();

        // ---- CREAR CONTACTO ----
        formCrear.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearFormErrors(formCrear);

            const data = {
                nombre: document.getElementById("crear_nombre").value.trim(),
                correo: document.getElementById("crear_correo").value.trim(),
                telefono: document.getElementById("crear_telefono").value.trim(),
                direccion: document.getElementById("crear_direccion").value.trim()
            };

            try {
                const response = await fetch(apiUrl, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    modalCrear.hide();
                    showAlert('Contacto creado correctamente.', 'success', 3000);
                    fetchContactos();
                } else {
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        const err = await response.json();
                        displayFormErrors(formCrear, err);
                    } else {
                        const text = await response.text();
                        showAlert(text || 'Error al crear contacto');
                    }
                }
            } catch (err) {
                showAlert('Error de red al crear contacto.');
            }
        });

        // ---- EDITAR CONTACTO ----
        function mostrarEditar(contacto) {
            clearFormErrors(formEditar);
            document.getElementById("editar_id").value = contacto.id;
            document.getElementById("editar_nombre").value = contacto.nombre || '';
            document.getElementById("editar_correo").value = contacto.correo || '';
            document.getElementById("editar_telefono").value = contacto.telefono || '';
            document.getElementById("editar_direccion").value = contacto.direccion || '';
            modalEditar.show();
        }

        formEditar.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearFormErrors(formEditar);

            const id = document.getElementById("editar_id").value;
            const data = {
                nombre: document.getElementById("editar_nombre").value.trim(),
                correo: document.getElementById("editar_correo").value.trim(),
                telefono: document.getElementById("editar_telefono").value.trim(),
                direccion: document.getElementById("editar_direccion").value.trim()
            };

            try {
                const response = await fetch(apiUrl + id + "/", {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    modalEditar.hide();
                    showAlert('Contacto actualizado correctamente.', 'success', 3000);
                    fetchContactos();
                } else {
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        const err = await response.json();
                        displayFormErrors(formEditar, err);
                    } else {
                        const text = await response.text();
                        showAlert(text || 'Error al actualizar contacto');
                    }
                }
            } catch (err) {
                showAlert('Error de red al actualizar contacto.');
            }
        });

        // ---- ELIMINAR CONTACTO ----
        async function eliminarContacto(id) {
            if (!confirm("¿Seguro que deseas eliminar este contacto?")) return;
            try {
                const response = await fetch(apiUrl + id + "/", {
                    method: "DELETE",
                    headers: { "Authorization": "Bearer " + token }
                });

                if (response.ok) {
                    showAlert('Contacto eliminado.', 'success', 2500);
                    fetchContactos();
                } else {
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        const err = await response.json();
                        showAlert(JSON.stringify(err), 'danger', 5000);
                    } else {
                        showAlert('Error al eliminar contacto');
                    }
                }
            } catch (err) {
                showAlert('Error de red al eliminar contacto.');
            }
        }
    </script>

</body>
</html>