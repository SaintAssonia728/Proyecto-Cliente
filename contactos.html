<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Contactos</title>
    <link rel="stylesheet" href="css/styless.css">
</head>
<body>

    <div class="container">
        <h1>Lista de Contactos</h1>

        <button id="btnCrear" class="btn">Crear Contacto</button>

        <ul id="contactosList"></ul>
        <div id="errorMessage" class="error"></div>
    </div>

    <!-- FORMULARIO CREAR -->
    <div id="formCrear" class="modal" style="display:none;">
        <div class="modal-content">
            <h3>Crear Contacto</h3>
            <form onsubmit="crearContacto(event)">
                <input type="text" id="crear_nombre" placeholder="Nombre" required>
                <input type="email" id="crear_correo" placeholder="Correo" required>
                <input type="text" id="crear_telefono" placeholder="Teléfono" required>
                <input type="text" id="crear_direccion" placeholder="Dirección" required>
                <button type="submit">Guardar</button>
                <button type="button" onclick="cerrarCrear()">Cancelar</button>
            </form>
        </div>
    </div>

    <!-- FORMULARIO EDITAR -->
    <div id="formEditar" class="modal" style="display:none;">
        <div class="modal-content">
            <h3>Editar Contacto</h3>
            <form onsubmit="editarContacto(event)">
                <input type="hidden" id="editar_id">
                <input type="text" id="editar_nombre" placeholder="Nombre" required>
                <input type="email" id="editar_correo" placeholder="Correo" required>
                <input type="text" id="editar_telefono" placeholder="Teléfono" required>
                <input type="text" id="editar_direccion" placeholder="Dirección" required>
                <button type="submit">Actualizar</button>
                <button type="button" onclick="cerrarEditar()">Cancelar</button>
            </form>
        </div>
    </div>

    <script>
        const apiUrl = 'http://localhost:8000/api/contactos/';

        // VALIDAR TOKEN
        if (!localStorage.getItem('access_token')) {
            window.location.href = 'index.html';
        }

        document.getElementById("btnCrear").addEventListener("click", () => {
            document.getElementById("formCrear").style.display = "flex";
        });

        // ---- LISTAR CONTACTOS ----
        async function fetchContactos() {
            try {
                const response = await fetch(apiUrl, {
                    method: "GET",
                    headers: { "Authorization": "Bearer " + localStorage.getItem("access_token") }
                });

                if (!response.ok) throw new Error("Error al obtener contactos");

                const data = await response.json();
                const contactosList = document.getElementById("contactosList");
                contactosList.innerHTML = "";

                data.results.forEach(contacto => {
                    const li = document.createElement("li");
                    li.classList.add("card");
                    li.innerHTML = `
                        <strong>${contacto.nombre}</strong><br>
                        - ${contacto.correo}<br>
                        ${contacto.telefono}<br>
                        ${contacto.direccion}<br><br>

                        <button class="btn-edit" onclick="mostrarEditar(${contacto.id}, '${contacto.nombre}', '${contacto.correo}', '${contacto.telefono}', '${contacto.direccion}')">Editar</button>
                        <button class="btn-delete" onclick="eliminarContacto(${contacto.id})">Eliminar</button>
                    `;
                    contactosList.appendChild(li);
                });

            } catch (error) {
                showError(error.message);
            }
        }

        fetchContactos();

        // ---- CREAR CONTACTO ----
        async function crearContacto(event) {
            event.preventDefault();

            const data = {
                nombre: document.getElementById("crear_nombre").value,
                correo: document.getElementById("crear_correo").value,
                telefono: document.getElementById("crear_telefono").value,
                direccion: document.getElementById("crear_direccion").value
            };

            const response = await fetch(apiUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + localStorage.getItem("access_token")
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                cerrarCrear();
                fetchContactos();
            } else showError("Error al crear contacto");
        }

        function cerrarCrear() {
            document.getElementById("formCrear").style.display = "none";
        }

        // ---- EDITAR CONTACTO ----
        function mostrarEditar(id, nombre, correo, telefono, direccion) {
            document.getElementById("formEditar").style.display = "flex";

            document.getElementById("editar_id").value = id;
            document.getElementById("editar_nombre").value = nombre;
            document.getElementById("editar_correo").value = correo;
            document.getElementById("editar_telefono").value = telefono;
            document.getElementById("editar_direccion").value = direccion;
        }

        function cerrarEditar() {
            document.getElementById("formEditar").style.display = "none";
        }

        async function editarContacto(event) {
            event.preventDefault();

            const id = document.getElementById("editar_id").value;
            const data = {
                nombre: document.getElementById("editar_nombre").value,
                correo: document.getElementById("editar_correo").value,
                telefono: document.getElementById("editar_telefono").value,
                direccion: document.getElementById("editar_direccion").value
            };

            const response = await fetch(apiUrl + id + "/", {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + localStorage.getItem("access_token")
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                cerrarEditar();
                fetchContactos();
            } else showError("Error al actualizar contacto");
        }

        // ---- ELIMINAR CONTACTO ----
        async function eliminarContacto(id) {
            if (!confirm("¿Seguro que deseas eliminar este contacto?")) return;

            const response = await fetch(apiUrl + id + "/", {
                method: "DELETE",
                headers: { "Authorization": "Bearer " + localStorage.getItem("access_token") }
            });

            if (response.ok) fetchContactos();
            else showError("Error al eliminar contacto");
        }

        // ---- ERROR ----
        function showError(message) {
            document.getElementById("errorMessage").innerText = message;
        }
    </script>

</body>
</html>
