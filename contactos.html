<!DOCTYPE html>

<html lang="es">

<head>

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Lista de Contactos</title>



  <!-- Bootstrap 5 -->

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles -->

  <link rel="stylesheet" href="css/styles.css">

</head>

<body>



  <div class="container py-4">

    <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3 mb-3">

      <h1 class="h4 mb-0">Lista de Contactos</h1>

      <div class="d-flex gap-2">

        <button id="btnCrear" class="btn btn-primary">Crear Contacto</button>

        <button id="btnLogout" class="btn btn-outline-secondary">Cerrar sesión</button>

      </div>

    </div>



    <div id="alertContainer" class="mb-3"></div>



    <!-- Grid responsivo: xs=1, sm=2, md=2, lg=3, xl=4 -->

    <div id="contactosList" class="row g-3"></div>



    <div id="loading" class="text-center my-4 visually-hidden">

      <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>

    </div>

  </div>



  <!-- Modal Crear (fullscreen en móviles) -->

  <div class="modal fade" id="modalCrear" tabindex="-1" aria-hidden="true">

    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">

      <div class="modal-content">

        <form id="formCrear" novalidate>

          <div class="modal-header">

            <h5 class="modal-title">Crear Contacto</h5>

            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>

          </div>

          <div class="modal-body">

            <div id="crear_alert"></div>



            <div class="mb-3">

              <label for="crear_nombre" class="form-label">Nombre</label>

              <input id="crear_nombre" name="nombre" type="text" maxlength="50" class="form-control" placeholder="Nombre (máx 50)" required>

              <div class="invalid-feedback" data-field="nombre"></div>

            </div>



            <div class="mb-3">

              <label for="crear_correo" class="form-label">Correo</label>

              <input id="crear_correo" name="correo" type="email" maxlength="50" class="form-control" placeholder="correo@ejemplo.com" required>

              <div class="invalid-feedback" data-field="correo"></div>

            </div>



            <div class="mb-3">

              <label for="crear_telefono" class="form-label">Teléfono</label>

              <input id="crear_telefono" name="telefono" type="text" maxlength="12" class="form-control" placeholder="+56912345678" required>

              <div class="invalid-feedback" data-field="telefono"></div>

            </div>



            <div class="mb-3">

              <label for="crear_direccion" class="form-label">Dirección</label>

              <input id="crear_direccion" name="direccion" type="text" maxlength="100" class="form-control" placeholder="Dirección (máx 100)" required>

              <div class="invalid-feedback" data-field="direccion"></div>

            </div>

          </div>



          <div class="modal-footer">

            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>

            <button type="submit" class="btn btn-primary">Guardar</button>

          </div>

        </form>

      </div>

    </div>

  </div>



  <!-- Modal Editar (fullscreen en móviles) -->

  <div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">

    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">

      <div class="modal-content">

        <form id="formEditar" novalidate>

          <div class="modal-header">

            <h5 class="modal-title">Editar Contacto</h5>

            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>

          </div>

          <div class="modal-body">

            <div id="editar_alert"></div>

            <input type="hidden" id="editar_id" name="id">



            <div class="mb-3">

              <label for="editar_nombre" class="form-label">Nombre</label>

              <input id="editar_nombre" name="nombre" type="text" maxlength="50" class="form-control" placeholder="Nombre (máx 50)" required>

              <div class="invalid-feedback" data-field="nombre"></div>

            </div>



            <div class="mb-3">

              <label for="editar_correo" class="form-label">Correo</label>

              <input id="editar_correo" name="correo" type="email" maxlength="50" class="form-control" placeholder="correo@ejemplo.com" required>

              <div class="invalid-feedback" data-field="correo"></div>

            </div>



            <div class="mb-3">

              <label for="editar_telefono" class="form-label">Teléfono</label>

              <input id="editar_telefono" name="telefono" type="text" maxlength="12" class="form-control" placeholder="+56912345678" required>

              <div class="invalid-feedback" data-field="telefono"></div>

            </div>



            <div class="mb-3">

              <label for="editar_direccion" class="form-label">Dirección</label>

              <input id="editar_direccion" name="direccion" type="text" maxlength="100" class="form-control" placeholder="Dirección (máx 100)" required>

              <div class="invalid-feedback" data-field="direccion"></div>

            </div>

          </div>



          <div class="modal-footer">

            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>

            <button type="submit" class="btn btn-success">Actualizar</button>

          </div>

        </form>

      </div>

    </div>

  </div>



  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>



  <script>

    const apiUrl = 'https://pruebadeagenda-render.onrender.com/api/contactos/';

    const token = localStorage.getItem('access_token');

    if (!token) location.href = 'index.html';



    const alertContainer = document.getElementById('alertContainer');

    function showAlert(msg, type='danger', timeout=6000){

      alertContainer.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${escapeHtml(msg)}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;

      if (timeout) setTimeout(()=>{ const a = alertContainer.querySelector('.alert'); if (a) bootstrap.Alert.getOrCreateInstance(a).close(); }, timeout);

    }

    function escapeHtml(str){ if (str==null) return ''; return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }

    function clearFormErrors(form){ form.querySelectorAll('.is-invalid').forEach(i=>i.classList.remove('is-invalid')); form.querySelectorAll('.invalid-feedback').forEach(f=>f.textContent=''); const la = form.querySelector('[id$="_alert"]'); if(la) la.innerHTML=''; }

    function displayFormErrors(form, errors){

      clearFormErrors(form);

      for(const [k,v] of Object.entries(errors || {})){

        const msg = Array.isArray(v) ? v.join(' ') : String(v);

        if (k==='non_field_errors' || k==='detail' || k==='error'){

          const container = form.querySelector('[id$="_alert"]');

          if (container) container.innerHTML = `<div class="alert alert-danger">${escapeHtml(msg)}</div>`; else showAlert(msg,'danger');

        } else {

          const field = form.querySelector(`[name="${k}"]`) || form.querySelector(`#${k}`);

          if (field){ field.classList.add('is-invalid'); let fb = form.querySelector(`.invalid-feedback[data-field="${k}"]`); if(!fb) fb = field.nextElementSibling; if(fb) fb.textContent = msg; }

          else showAlert(`${k}: ${msg}`, 'danger');

        }

      }

    }



    // modales & forms

    const modalCrear = new bootstrap.Modal(document.getElementById('modalCrear'));

    const modalEditar = new bootstrap.Modal(document.getElementById('modalEditar'));

    const formCrear = document.getElementById('formCrear');

    const formEditar = document.getElementById('formEditar');



    document.getElementById('btnCrear').addEventListener('click', ()=>{

      formCrear.reset(); clearFormErrors(formCrear); modalCrear.show();

    });

    document.getElementById('btnLogout').addEventListener('click', ()=>{ localStorage.removeItem('access_token'); location.href='index.html'; });



    // responsive card renderer

    const contactosList = document.getElementById('contactosList');

    const loadingEl = document.getElementById('loading');



    function renderContactCard(contacto){

      const col = document.createElement('div');

      col.className = 'col-12 col-sm-6 col-md-6 col-lg-4 col-xl-3';



      const card = document.createElement('div');

      card.className = 'card card-contact h-100';



      // body layout: column on xs, row on md+

      const body = document.createElement('div');

      body.className = 'card-body d-flex flex-column flex-md-row justify-content-between gap-2 align-items-start';



      const info = document.createElement('div');

      info.className = 'flex-grow-1';

      info.innerHTML = `<h5 class="card-title mb-1 text-truncate">${escapeHtml(contacto.nombre)}</h5>

                        <p class="card-text mb-0 text-truncate"><small class="text-muted">Correo: </small>${escapeHtml(contacto.correo)}</p>

                        <p class="card-text mb-0 text-truncate"><small class="text-muted">Teléfono: </small>${escapeHtml(contacto.telefono)}</p>

                        <p class="card-text mb-0 text-truncate"><small class="text-muted">Dirección: </small>${escapeHtml(contacto.direccion)}</p>`;



      const actions = document.createElement('div');

      actions.className = 'd-flex flex-row flex-md-column gap-2 align-items-center align-items-md-end';



      const btnEdit = document.createElement('button');

      btnEdit.className = 'btn btn-sm btn-outline-primary';

      btnEdit.textContent = 'Editar';

      btnEdit.addEventListener('click', ()=> mostrarEditar(contacto));



      const btnDel = document.createElement('button');

      btnDel.className = 'btn btn-sm btn-outline-danger';

      btnDel.textContent = 'Eliminar';

      btnDel.addEventListener('click', ()=> eliminarContacto(contacto.id));



      actions.appendChild(btnEdit);

      actions.appendChild(btnDel);



      body.appendChild(info);

      body.appendChild(actions);

      card.appendChild(body);

      col.appendChild(card);

      return col;

    }



    async function fetchContactos(){

      try{

        loadingEl.classList.remove('visually-hidden');

        const res = await fetch(apiUrl, { headers: { 'Authorization': 'Bearer ' + token } });

        if (!res.ok) { if (res.status===401){ showAlert('Sesión expirada','warning'); localStorage.removeItem('access_token'); setTimeout(()=>location.href='index.html',1200); } else throw new Error('Error al obtener contactos'); return; }

        const json = await res.json();

        const items = Array.isArray(json.results) ? json.results : (Array.isArray(json) ? json : []);

        contactosList.innerHTML = '';

        if (items.length===0) contactosList.innerHTML = '<div class="col-12"><div class="alert alert-info">No hay contactos.</div></div>';

        items.forEach(c => contactosList.appendChild(renderContactCard(c)));

      } catch(err){ showAlert(err.message || 'Error'); }

      finally{ loadingEl.classList.add('visually-hidden'); }

    }

    fetchContactos();



    // simple normalize & validation (as before) - keep on frontend but backend must enforce uniqueness

    const PHONE_RE = /^\+569\d{8}$/;

    function normalizeTelefono(raw){

      if (raw==null) return raw;

      const s = String(raw).trim().replace(/[\s\-]/g,'');

      if (/^\+569\d{8}$/.test(s)) return s;

      if (/^569\d{8}$/.test(s)) return '+'+s;

      if (/^09\d{8}$/.test(s)) return '+56'+s.slice(1);

      if (/^9\d{8}$/.test(s)) return '+56'+s;

      return s;

    }

    function validateContactData(data){

      const errors = {};

      if (!data.nombre || data.nombre.trim()==='') errors.nombre=['Este campo es obligatorio.'];

      else if (data.nombre.length>50) errors.nombre=['Máx 50 caracteres.'];



      if (!data.correo || data.correo.trim()==='') errors.correo=['Este campo es obligatorio.'];

      else if (data.correo.length>50) errors.correo=['Máx 50 caracteres.'];

      else { const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; if (!emailRe.test(data.correo)) errors.correo=['Email inválido.']; }



      if (!data.telefono || data.telefono.trim()==='') errors.telefono=['Este campo es obligatorio.'];

      else { const t=normalizeTelefono(data.telefono); if (!PHONE_RE.test(t)) errors.telefono=['Teléfono debe ser +569 y 8 dígitos.']; else data.telefono=t; }



      if (!data.direccion || data.direccion.trim()==='') errors.direccion=['Este campo es obligatorio.'];

      else if (data.direccion.length>100) errors.direccion=['Máx 100 caracteres.'];



      return errors;

    }



    // Create / Edit / Delete flows adapted to existing JS you had (kept simple)

    formCrear.addEventListener('submit', async (e)=>{

      e.preventDefault(); clearFormErrors(formCrear);

      const data = {

        nombre: document.getElementById('crear_nombre').value.trim(),

        correo: document.getElementById('crear_correo').value.trim(),

        telefono: document.getElementById('crear_telefono').value.trim(),

        direccion: document.getElementById('crear_direccion').value.trim()

      };

      const errs = validateContactData(data);

      if (Object.keys(errs).length){ displayFormErrors(formCrear, errs); return; }

      try {

        const r = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type':'application/json','Authorization':'Bearer '+token }, body: JSON.stringify(data) });

        if (r.ok){ modalCrear.hide(); showAlert('Contacto creado','success'); fetchContactos(); }

        else { const ct = r.headers.get('content-type')||''; if (ct.includes('application/json')) displayFormErrors(formCrear, await r.json()); else showAlert(await r.text()||'Error'); }

      } catch(err){ showAlert('Error de red'); }

    });



    function mostrarEditar(contacto){

      document.getElementById('editar_id').value = contacto.id;

      document.getElementById('editar_nombre').value = contacto.nombre || '';

      document.getElementById('editar_correo').value = contacto.correo || '';

      document.getElementById('editar_telefono').value = contacto.telefono || '';

      document.getElementById('editar_direccion').value = contacto.direccion || '';

      clearFormErrors(formEditar);

      modalEditar.show();

    }



    formEditar.addEventListener('submit', async (e)=>{

      e.preventDefault(); clearFormErrors(formEditar);

      const id = document.getElementById('editar_id').value;

      const data = {

        nombre: document.getElementById('editar_nombre').value.trim(),

        correo: document.getElementById('editar_correo').value.trim(),

        telefono: document.getElementById('editar_telefono').value.trim(),

        direccion: document.getElementById('editar_direccion').value.trim()

      };

      const errs = validateContactData(data);

      if (Object.keys(errs).length){ displayFormErrors(formEditar, errs); return; }

      try {

        const r = await fetch(apiUrl + id + '/', { method:'PUT', headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+token }, body: JSON.stringify(data) });

        if (r.ok){ modalEditar.hide(); showAlert('Contacto actualizado','success'); fetchContactos(); }

        else { const ct = r.headers.get('content-type')||''; if (ct.includes('application/json')) displayFormErrors(formEditar, await r.json()); else showAlert(await r.text()||'Error'); }

      } catch(err){ showAlert('Error de red'); }

    });



    async function eliminarContacto(id){

      if (!confirm('¿Eliminar contacto?')) return;

      try {

        const r = await fetch(apiUrl + id + '/', { method:'DELETE', headers:{ 'Authorization':'Bearer '+token }});

        if (r.ok){ showAlert('Eliminado','success'); fetchContactos(); }

        else { showAlert('No se pudo eliminar'); }

      } catch(err){ showAlert('Error de red'); }

    }

  </script>

</body>

</html>
